name: Deploy GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Run release gate (contracts + smokes + regressions)
        run: npm run release:gate

  deploy:
    needs: verify
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
      contents: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/configure-pages@v5

      - name: Build static artifact
        run: |
          mkdir -p dist
          cp -R \
            index.html \
            writing-studio.html \
            writing-studio.css \
            writing-studio.js \
            favicon.ico \
            sw.js \
            sw-runtime.js \
            style \
            js \
            data \
            assets \
            dist/

      - uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - id: deployment
        uses: actions/deploy-pages@v4

      - name: Smoke-check deployed page
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          CANONICAL_URL: https://bkseatown.github.io/WordQuest/
        run: |
          set -euo pipefail
          markers=(
            'id="settings-build-badge"'
            'src="js/app.js?v='
            'id="s-reveal-focus"'
            'id="s-assessment-lock"'
            'id="voice-history-strip"'
          )
          summary_file="${RUNNER_TEMP}/pages-smoke-summary.md"
          {
            echo "### Pages smoke check"
            echo
            echo "| URL | Result | Details |"
            echo "|---|---|---|"
          } > "${summary_file}"

          failures=0
          warnings=0
          targets=(
            "${PAGE_URL%/}/?cb=${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}|required"
            "${CANONICAL_URL%/}/?cb=${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}|optional"
          )

          for target_entry in "${targets[@]}"; do
            target="${target_entry%%|*}"
            requirement="${target_entry##*|}"
            echo "Smoke checking ${target}"
            passed=0
            details="Missing markers after retries."
            for attempt in 1 2 3 4 5 6 7 8; do
              tmp_html="${RUNNER_TEMP}/pages-smoke-${attempt}.html"
              http_code="$(curl -sSLo "${tmp_html}" -w "%{http_code}" --max-time 20 "${target}" || true)"
              html="$(cat "${tmp_html}" 2>/dev/null || true)"
              bytes="$(wc -c < "${tmp_html}" 2>/dev/null || echo 0)"
              missing=()
              for marker in "${markers[@]}"; do
                if [[ "${html}" != *"${marker}"* ]]; then
                  missing+=("${marker}")
                fi
              done
              if [ "${http_code}" = "200" ] && [ "${#missing[@]}" -eq 0 ]; then
                passed=1
                details="All markers found on attempt ${attempt} (HTTP ${http_code}, ${bytes} bytes)."
                break
              fi
              details="Attempt ${attempt}: HTTP ${http_code}, ${bytes} bytes, missing ${missing[*]}"
              echo "Smoke check retry ${attempt}/8: HTTP ${http_code}, ${bytes} bytes, missing ${missing[*]}"
              sleep $((attempt * 10))
            done

            if [ "${passed}" -eq 1 ]; then
              echo "| ${target} | ✅ PASS | ${details} |" >> "${summary_file}"
            else
              if [ "${requirement}" = "required" ]; then
                failures=$((failures + 1))
                echo "| ${target} | ❌ FAIL | ${details} |" >> "${summary_file}"
              else
                warnings=$((warnings + 1))
                echo "| ${target} | ⚠️ WARN | ${details} |" >> "${summary_file}"
              fi
            fi
          done

          cat "${summary_file}" >> "${GITHUB_STEP_SUMMARY}"
          if [ "${warnings}" -gt 0 ]; then
            echo "Non-blocking smoke-check warning(s): ${warnings} optional URL target(s) failed." >&2
          fi
          if [ "${failures}" -gt 0 ]; then
            echo "Blocking smoke-check failure(s): ${failures} required URL target(s) failed." >&2
            exit 1
          fi

  deploy-alert:
    needs:
      - deploy
    if: ${{ needs.deploy.result == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Open deploy alert issue
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `Deploy alert: GitHub Pages failed on ${context.sha.slice(0, 7)}`;
            const body = [
              'GitHub Pages deployment failed.',
              '',
              `- Run: ${runUrl}`,
              `- Commit: ${context.sha}`,
              `- Workflow: ${context.workflow}`,
              '',
              'Please run release checks and verify Pages status before next merge.'
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['bug']
            });
