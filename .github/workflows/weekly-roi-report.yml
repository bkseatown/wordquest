name: Weekly ROI Report

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13 * * 1'

permissions:
  contents: read
  issues: write

jobs:
  roi-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Prepare telemetry input
        env:
          TELEMETRY_REPORT_URL: ${{ secrets.TELEMETRY_REPORT_URL }}
          TELEMETRY_REPORT_TOKEN: ${{ secrets.TELEMETRY_REPORT_TOKEN }}
        run: |
          mkdir -p reports
          if [ -n "${TELEMETRY_REPORT_URL}" ]; then
            echo "Fetching telemetry report input from configured URL..."
            if [ -n "${TELEMETRY_REPORT_TOKEN}" ]; then
              curl -fsSL -H "Authorization: Bearer ${TELEMETRY_REPORT_TOKEN}" "${TELEMETRY_REPORT_URL}" -o reports/telemetry-input.json
            else
              curl -fsSL "${TELEMETRY_REPORT_URL}" -o reports/telemetry-input.json
            fi
          elif [ -f data/telemetry-weekly.json ]; then
            cp data/telemetry-weekly.json reports/telemetry-input.json
          else
            echo "[]" > reports/telemetry-input.json
          fi

      - name: Build weekly ROI report
        run: |
          node scripts/build-weekly-roi-report.js --input reports/telemetry-input.json --output reports/weekly-roi-report.md

      - name: Publish report to step summary
        run: |
          cat reports/weekly-roi-report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Detect threshold alerts
        id: alert_check
        run: |
          week_id="$(date -u +%G-W%V)"
          echo "week_id=${week_id}" >> "$GITHUB_OUTPUT"
          if grep -q "No threshold alerts this week." reports/weekly-roi-report.md; then
            echo "has_alerts=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_alerts=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Open issue for threshold alerts
        if: steps.alert_check.outputs.has_alerts == 'true'
        uses: actions/github-script@v7
        env:
          WEEK_ID: ${{ steps.alert_check.outputs.week_id }}
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const weekId = process.env.WEEK_ID || 'unknown-week';
            const title = `[ROI Alert] Weekly thresholds triggered (${weekId})`;
            const report = fs.readFileSync('reports/weekly-roi-report.md', 'utf8');

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100
            });
            const duplicate = existing.find((issue) => issue.title === title);

            if (duplicate) {
              core.info(`Existing alert issue found: #${duplicate.number}`);
              return;
            }

            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const body = [
              'Automated weekly ROI report detected threshold alerts.',
              '',
              `- Workflow run: ${runUrl}`,
              '',
              '---',
              '',
              report
            ].join('\n');

            const created = await github.rest.issues.create({
              owner,
              repo,
              title,
              body
            });
            core.info(`Created ROI alert issue: #${created.data.number}`);

      - name: Open weekly release health issue
        uses: actions/github-script@v7
        env:
          WEEK_ID: ${{ steps.alert_check.outputs.week_id }}
        with:
          script: |
            const fs = require('fs');

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const weekId = process.env.WEEK_ID || 'unknown-week';
            const title = `[Release Health] Weekly snapshot (${weekId})`;
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const report = fs.readFileSync('reports/weekly-roi-report.md', 'utf8');

            const scoreFor = (name) => {
              const regex = new RegExp(`\\|\\s*${name}\\s*\\|\\s*([^|]+?)\\s*\\|`, 'i');
              const match = report.match(regex);
              return match ? match[1].trim() : '--';
            };

            const adoption = scoreFor('Adoption');
            const learning = scoreFor('Learning');
            const reliability = scoreFor('Reliability');

            const sinceMs = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const fmtPct = (value) => (value === null ? '--' : `${Math.round(value)}%`);
            const fmtLatest = (run) => {
              if (!run) return '--';
              return `[${run.conclusion || run.status}](${run.html_url})`;
            };

            async function workflowStats(workflowId) {
              const response = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflowId,
                per_page: 100
              });
              const recentCompleted = (response.data.workflow_runs || [])
                .filter((run) => run.status === 'completed')
                .filter((run) => new Date(run.created_at).getTime() >= sinceMs);
              const successCount = recentCompleted.filter((run) => run.conclusion === 'success').length;
              const rate = recentCompleted.length ? (successCount / recentCompleted.length) * 100 : null;
              const latest = recentCompleted[0] || null;
              return { rate, total: recentCompleted.length, latest };
            }

            const [deploy, smoke] = await Promise.all([
              workflowStats('deploy-pages.yml'),
              workflowStats('ui-runtime-smoke.yml')
            ]);

            const body = [
              'Automated weekly release health snapshot.',
              '',
              `- Workflow run: ${runUrl}`,
              '',
              '## Reliability Dashboards',
              '',
              `- Adoption score: **${adoption}**`,
              `- Learning score: **${learning}**`,
              `- Reliability score: **${reliability}**`,
              '',
              '## CI Pass Rates (last 7 days)',
              '',
              `- Deploy GitHub Pages: **${fmtPct(deploy.rate)}** (${deploy.total} runs), latest ${fmtLatest(deploy.latest)}`,
              `- UI Runtime Smoke: **${fmtPct(smoke.rate)}** (${smoke.total} runs), latest ${fmtLatest(smoke.latest)}`,
              '',
              '## Weekly ROI Report',
              '',
              report
            ].join('\n');

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100
            });
            const duplicate = existing.find((issue) => issue.title === title);
            if (duplicate) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: duplicate.number,
                body
              });
              core.info(`Updated existing release health issue: #${duplicate.number}`);
              return;
            }

            const created = await github.rest.issues.create({
              owner,
              repo,
              title,
              body
            });
            core.info(`Created release health issue: #${created.data.number}`);

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: weekly-roi-report
          path: reports/weekly-roi-report.md
